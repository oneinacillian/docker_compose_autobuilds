global
    log /dev/log local0
    maxconn 4096
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

# AMQP Load Balancer for Hyperion
frontend amqp_frontend
    bind *:5672
    mode tcp
    default_backend amqp_backend

backend amqp_backend
    mode tcp
    balance roundrobin
    option tcp-check
    tcp-check connect port 5672
    server rabbitmq-1 rabbitmq-1:5672 check inter 2s rise 2 fall 3
    server rabbitmq-2 rabbitmq-2:5672 check inter 2s rise 2 fall 3
    server rabbitmq-3 rabbitmq-3:5672 check inter 2s rise 2 fall 3

# HTTP Management Load Balancer
frontend http_frontend
    bind *:15672
    mode http
    default_backend http_backend

backend http_backend
    mode http
    balance roundrobin
    option httpchk GET /api/overview
    http-check send meth GET uri /api/overview ver HTTP/1.1 hdr Host rabbitmq-loadbalancer hdr Authorization "Basic cmFiYml0bXF1c2VyOnJhYmJpdG1xcGFzcw==" hdr Connection close
    http-check expect status 200
    server rabbitmq-1 rabbitmq-1:15672 check inter 2s rise 2 fall 3
    server rabbitmq-2 rabbitmq-2:15672 check inter 2s rise 2 fall 3
    server rabbitmq-3 rabbitmq-3:15672 check inter 2s rise 2 fall 3

# Prometheus Metrics Load Balancer
frontend prometheus_frontend
    bind *:15692
    mode http
    default_backend prometheus_backend

backend prometheus_backend
    mode http
    balance roundrobin
    option httpchk GET /metrics
    http-check expect status 200
    server rabbitmq-1 rabbitmq-1:15692 check inter 2s rise 2 fall 3
    server rabbitmq-2 rabbitmq-2:15692 check inter 2s rise 2 fall 3
    server rabbitmq-3 rabbitmq-3:15692 check inter 2s rise 2 fall 3
